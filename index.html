<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de pacientes</title>
    <style>
        .hidden {
            display: none;
        }

        body {
            font-family: 'Lato', sans-serif;
        }

        .barra-pesquisa {
            position: relative;
            display: inline-block;
        }

        .barraPesquisaInput {
            padding-left: 50px;
            height: 30px;
            border-radius: 8px;
            border: 1px solid;
            width: 900px;
            font-size: large;
        }

        .icone-lupa {
            position: absolute;
            left: 1%;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            pointer-events: none;
        }

        .botao-pesquisar {
            position: absolute;
            left: 90%;
            top: 50%;
            transform: translateY(-50%);
        }

        .botao-limpar {
            font-size: 15px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Registro de pacientes</h1>

    <div id="PacientesCadastrados">
        <h2>Pacientes cadastrados</h2>

        <button onclick="AbrirSecaoCadastro()">Cadastrar um novo paciente</button>
        <br><br>

        <div class="barra-pesquisa" id="barraPesquisaPacientesDiv">
            <input type="text" class="barraPesquisaInput" id="barraPesquisaPacientes"
                placeholder="Buscar paciente por nome ou telefone...">
            <img src="Imagens/lupa.png" class="icone-lupa">
            <button class="botao-pesquisar" onclick="PesquisarPaciente()">Pesquisar</button>
        </div>

        <button id="botaoLimparPesquisa" class="botao-limpar hidden" onclick="LimparPesquisaPacientes()">Limpar
            pesquisa</button>
        <br><br>

        <table border="1" id="TabelaPacientesCadastradosInteira">
            <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>Data de nascimento</th>
                <th>Telefone</th>
                <th>Profissão</th>
                <th>Bairro</th>
                <th colspan="3">Opções de configuração</th>
            </tr>
            <tbody id="TabelaPacientesCadastrados"></tbody>
        </table>

        <p id="avisoPacienteNaoEncontrado" class="hidden">Nenhum paciente foi encontrado. Verifique se o nome ou telefone está correto!</p>
    </div>

    <div id="SecaoCadastroPacientes" class="hidden">
        <h2>Pacientes cadastrados<h2>
                <h3>Cadastro - informações do paciente</h3>

                <p>Nome: <input type="text" id="nomePacienteInput" placeholder="Digite o nome"></p>
                <p>CPF: <input type="text" id="cpfPacienteInput" placeholder="Digite o CPF"></p>
                <p>Data de nascimento: <input type="date" id="dataNascPacienteInput"></p>
                <p>Telefone: <input type="text" id="telefonePacienteInput" placeholder="Digite o n° de telefone"></p>
                <p>Profissão: <input type="text" id="profissaoPacienteInput" placeholder="Digite a profissão"></p>
                <p>Bairro: <input type="text" id="bairroPacienteInput" placeholder="Digite o bairro de moradia"></p>
                <br>

                <button onclick="CadastrarPaciente()" id="botaoSalvar">Salvar</button>
                <button onclick="FecharSecaoCadastro()">Cancelar</button>
    </div>

    <div id="HistoricoAtendimentos" class="hidden">
        <h2>Historico de atendimentos</h2>

        <button onclick="FecharHistoricoAtend()">Voltar a tabela dos clientes cadastrados</button>
        <br><br>

        <button onclick="AbrirSecaoRegistroAtend()">Registrar um novo atendimento</button>
        <br><br>

        <div class="barra-pesquisa">
            <input type="text" class="barraPesquisaInput" id="barraPesquisaAtendimentos"
                placeholder="Buscar atendimento por data, horário ou serviço...">
            <img src="Imagens/lupa.png" class="icone-lupa">
            <button class="botao-pesquisar">Pesquisar</button>
        </div>

        <button id="botaoLimparPesquisa" class="botao-limpar hidden" onclick="LimparPesquisaPacientes()">Limpar
            pesquisa</button>
        <br><br>

        <table border="1">
            <tr>
                <th>Data</th>
                <th>Horário</th>
                <th>Serviço</th>
                <th>Valor</th>
                <th>Forma de pagamento</th>
                <th colspan="2">Opções de configuração</th>
            </tr>
            <tbody id="TabelaHistoricoAtendimentos"></tbody>
        </table>
    </div>

    <div id="SecaoRegistroAtendimentos" class="hidden">
        <h2>Historico de atendimentos</h2>

        <h3>Informações do atendimento</h3>

        <p>Data: <input type="date" id="dataAtendInput"></p>
        <p>Horário: <input type="time" id="horarioAtendInput"></p>
        <p>Serviço: <input type="text" id="servicoAtendInput" placeholder="Selecione uma servico"></p>
        <p>Valor: <input type="number" id="valorAtendInput" placeholder="Digite o valor do atendimento"></p>
        <p>Forma de pagamento: <input type="text" id="formaPagamentoAtendInput"
                placeholder="Selecione uma forma de pagamento"></p>
        <br>
        <button onclick="RegistrarAtendimento()">Salvar</button>
        <button onclick="FecharSecaoRegistroAtend()">Cancelar</button>
    </div>

    <script>
        let pacientes = JSON.parse(localStorage.getItem("pacientes")) || []

        const divPacientesCadastrados = document.getElementById("PacientesCadastrados")
        const divCadastroPacientes = document.getElementById("SecaoCadastroPacientes")
        const divInformacoesHistAtend = document.getElementById("SecaoInformacoesHistAtend")
        const divHistoricoAtend = document.getElementById("HistoricoAtendimentos")
        const divRegistroAtend = document.getElementById("SecaoRegistroAtendimentos")

        let posicaoPacienteAtual = null
        let posicaoAtendimentoAtual = null

        let editando = false

        function AbrirSecaoCadastro() {
            divCadastroPacientes.classList.remove("hidden")
            divPacientesCadastrados.classList.add("hidden")
        }
        function FecharSecaoCadastro() {
            nomePaciente.value = ""
            cpfPaciente.value = ""
            dataNascPaciente.value = ""
            telefonePaciente.value = ""
            profissaoPaciente.value = ""
            bairroPaciente.value = ""

            editando = false

            divCadastroPacientes.classList.add("hidden")
            divPacientesCadastrados.classList.remove("hidden")
        }
        function AbrirHistoricoAtend(i) {
            posicaoPacienteAtual = i

            divHistoricoAtend.classList.remove("hidden")
            divPacientesCadastrados.classList.add("hidden")

            AtualizarTabelaHistAtend()
        }
        function FecharHistoricoAtend() {
            divHistoricoAtend.classList.add("hidden")
            divPacientesCadastrados.classList.remove("hidden")
        }
        function AbrirSecaoRegistroAtend() {
            divHistoricoAtend.classList.add("hidden")
            divRegistroAtend.classList.remove("hidden")
        }
        function FecharSecaoRegistroAtend() {
            dataAtend.value = ""
            horarioAtend.value = ""
            servicoAtend.value = ""
            valorAtend.value = ""
            formaPagamentoAtend.value = ""

            divHistoricoAtend.classList.remove("hidden")
            divRegistroAtend.classList.add("hidden")
        }

        const nomePaciente = document.getElementById("nomePacienteInput")
        const cpfPaciente = document.getElementById("cpfPacienteInput")
        const dataNascPaciente = document.getElementById("dataNascPacienteInput")
        const telefonePaciente = document.getElementById("telefonePacienteInput")
        const profissaoPaciente = document.getElementById("profissaoPacienteInput")
        const bairroPaciente = document.getElementById("bairroPacienteInput")

        const TabelaPacientesCadastrados = document.getElementById("TabelaPacientesCadastrados")

        function CadastrarPaciente() {
            let paciente = {
                nome: nomePaciente.value.trim(),
                cpf: cpfPaciente.value.replace(/\D/g, '').trim(),
                data_nascimento: dataNascPaciente.value.trim(),
                telefone: telefonePaciente.value.replace(/\D/g, '').trim(),
                profissao: profissaoPaciente.value.trim(),
                bairro: bairroPaciente.value.trim(),
                historico_atendimentos: []
            }

            if (editando) {
                paciente.historico_atendimentos = pacientes[posicaoPacienteAtual].historico_atendimentos
                pacientes[posicaoPacienteAtual] = paciente
                editando = false
            }
            else {
                pacientes.push(paciente)
            }

            localStorage.setItem("pacientes", JSON.stringify(pacientes))

            FecharSecaoCadastro()
            AtualizarTabela()
        }

        window.onload = function () {
            AtualizarTabela()
        }

        function AtualizarTabela() {
            TabelaPacientesCadastrados.innerHTML = ""

            for (let i = 0; i < pacientes.length; i++) {
                const linha = document.createElement("tr")
                linha.innerHTML = `
                        <th>${pacientes[i].nome.trim()}</th>
                        <th>${pacientes[i].cpf.trim()}</th>
                        <th>${pacientes[i].data_nascimento.trim()}</th>
                        <th>${pacientes[i].telefone.trim()}</th>
                        <th>${pacientes[i].profissao.trim()}</th>
                        <th>${pacientes[i].bairro.trim()}</th>
                        <th><button onclick="ExcluirPaciente(${i})">Exluir</button></th>
                        <th><button onclick="EditarPaciente(${i})">Editar</button></th>
                        <th><button onclick="AbrirHistoricoAtend(${i})">Histórico de atendimentos</button></th>
                    `
                TabelaPacientesCadastrados.appendChild(linha)
            }
        }

        function ExcluirPaciente(i) {
            const confirmar = confirm("Deseja mesmo excluir esse paciente?")

            if (confirmar) {
                pacientes.splice(i, 1) // remove do array
                localStorage.setItem("pacientes", JSON.stringify(pacientes)) // remove do localstorage

                AtualizarTabela()
            }
        }

        function EditarPaciente(i) {
            AbrirSecaoCadastro()

            nomePaciente.value = pacientes[i].nome
            cpfPaciente.value = pacientes[i].cpf
            dataNascPaciente.value = pacientes[i].data_nascimento
            telefonePaciente.value = pacientes[i].telefone
            profissaoPaciente.value = pacientes[i].profissao
            bairroPaciente.value = pacientes[i].bairro

            editando = true
            posicaoPacienteAtual = i
        }

        const dataAtend = document.getElementById("dataAtendInput")
        const horarioAtend = document.getElementById("horarioAtendInput")
        const servicoAtend = document.getElementById("servicoAtendInput")
        const valorAtend = document.getElementById("valorAtendInput")
        const formaPagamentoAtend = document.getElementById("formaPagamentoAtendInput")

        const TabelaHistoricoAtendimentos = document.getElementById("TabelaHistoricoAtendimentos")
        const TabelaPacientesCadastradosInteira = document.getElementById("TabelaPacientesCadastradosInteira")

        function RegistrarAtendimento() {
            let atendimento = {
                data: dataAtend.value.trim(),
                horario: horarioAtend.value.trim(),
                servico: servicoAtend.value.trim(),
                valor: valorAtend.value,
                forma_pagamento: formaPagamentoAtend.value.trim()
            }

            if (editando) {
                pacientes[posicaoPacienteAtual].historico_atendimentos[posicaoAtendimentoAtual] = atendimento
                editando = false
            }
            else {
                pacientes[posicaoPacienteAtual].historico_atendimentos.push(atendimento)
            }

            localStorage.setItem("pacientes", JSON.stringify(pacientes))

            alert("Atendimento registrado com sucesso!")
            AtualizarTabelaHistAtend()
            FecharSecaoRegistroAtend()
        }

        function AtualizarTabelaHistAtend() {
            if (posicaoPacienteAtual == null)
                return

            if (!pacientes[posicaoPacienteAtual] || !pacientes[posicaoPacienteAtual].historico_atendimentos)
                return

            TabelaHistoricoAtendimentos.innerHTML = ""

            for (let i = 0; i < pacientes[posicaoPacienteAtual].historico_atendimentos.length; i++) {
                const atendimento = pacientes[posicaoPacienteAtual].historico_atendimentos[i]

                const linha = document.createElement("tr")
                linha.innerHTML = `
                        <th>${atendimento.data.trim()}</th>
                        <th>${atendimento.horario.trim()}</th>
                        <th>${atendimento.servico.trim()}</th>
                        <th>${atendimento.valor}</th>
                        <th>${atendimento.forma_pagamento.trim()}</th> 
                        <th><button onclick="EditarAtendimento(${i})">Editar</button></th>
                        <th><button onclick="ExcluirAtendimento(${i})">Excluir</button></th>
                        `

                TabelaHistoricoAtendimentos.appendChild(linha)
            }
        }

        function ExcluirAtendimento(i) {
            const confirmar = confirm("Deseja mesmo excluir esse atendimento?")

            if (confirmar) {
                pacientes[posicaoPacienteAtual].historico_atendimentos.splice(i, 1)
                localStorage.setItem("pacientes", JSON.stringify(pacientes))

                AtualizarTabelaHistAtend()
            }
        }

        function EditarAtendimento(i) {
            AbrirSecaoRegistroAtend()

            dataAtend.value = pacientes[posicaoPacienteAtual].historico_atendimentos[i].data
            horarioAtend.value = pacientes[posicaoPacienteAtual].historico_atendimentos[i].horario
            servicoAtend.value = pacientes[posicaoPacienteAtual].historico_atendimentos[i].servico
            valorAtend.value = pacientes[posicaoPacienteAtual].historico_atendimentos[i].valor
            formaPagamentoAtend.value = pacientes[posicaoPacienteAtual].historico_atendimentos[i].forma_pagamento

            editando = true

            posicaoAtendimentoAtual = i
        }

        const barraPesquisaPacientes = document.getElementById("barraPesquisaPacientes")
        const botaoLimparPesquisa = document.getElementById("botaoLimparPesquisa")

        const avisoPacienteNaoEncontrado = document.getElementById("avisoPacienteNaoEncontrado")

        barraPesquisaPacientes.addEventListener("input", () => {
            if (barraPesquisaPacientes.value.trim() != "") {
                botaoLimparPesquisa.classList.remove("hidden")
            }
            else {
                botaoLimparPesquisa.classList.add("hidden")
            }
        })

        function PesquisarPaciente() {
            TabelaPacientesCadastradosInteira.classList.remove("hidden")
            avisoPacienteNaoEncontrado.classList.add("hidden")

            const termo = barraPesquisaPacientes.value.trim().toLowerCase()
            TabelaPacientesCadastrados.innerHTML = ""

            if (termo == "") {
                AtualizarTabela()
                return
            }

            let encontrou = false

            for (let i = 0; i < pacientes.length; i++) {
                const nome = pacientes[i].nome.toLowerCase()
                const telefone = pacientes[i].telefone.toLowerCase()

                if (nome.includes(termo) || telefone.includes(termo)) {
                    const linha = document.createElement("tr")

                    linha.innerHTML = `
                        <th>${pacientes[i].nome.trim()}</th>
                        <th>${pacientes[i].cpf.trim()}</th>
                        <th>${pacientes[i].data_nascimento.trim()}</th>
                        <th>${pacientes[i].telefone.trim()}</th>
                        <th>${pacientes[i].profissao.trim()}</th>
                        <th>${pacientes[i].bairro.trim()}</th>
                        <th><button onclick="ExcluirPaciente(${i})">Exluir</button></th>
                        <th><button onclick="EditarPaciente(${i})">Editar</button></th>
                        <th><button onclick="AbrirHistoricoAtend(${i})">Histórico de atendimentos</button></th>
                    `
                    TabelaPacientesCadastrados.appendChild(linha)
                    encontrou = true
                }
            }

            if (encontrou == false) {
                TabelaPacientesCadastradosInteira.classList.add("hidden")
                avisoPacienteNaoEncontrado.classList.remove("hidden")
            }
        }

        function LimparPesquisaPacientes() {
            barraPesquisaPacientes.value = ""
            TabelaPacientesCadastradosInteira.classList.remove("hidden")
            avisoPacienteNaoEncontrado.classList.add("hidden")
            botaoLimparPesquisa.classList.add("hidden")
            AtualizarTabela()
        }
    </script>

</body>

</html>